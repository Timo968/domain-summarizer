<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>Domain Summarizer</title>
</head>
<body onload="askForApiKey()">
  <div class="container">
    <h1>Domain Summarizer</h1>
    <input type="text" id="url" placeholder="URL eingeben" onkeydown="handleEnterKey(event)">
    <button onclick="fetchMetadata()">Daten abrufen</button>
    <div id="result"></div>
  </div>

  <script>
    let apiKey = '';

    function askForApiKey() {
      apiKey = prompt('Please enter your ChatGPT API key:');
    }

    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        fetchMetadata();
      }
    }

    async function callChatGPT(messages) {
      const url = 'https://api.openai.com/v1/chat/completions';

      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      };

      const body = JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages: messages
      });

      const response = await fetch(url, {
        method: 'POST',
        headers: headers,
        body: body
      });

      if (response.ok) {
        const data = await response.json();
        return data.choices[0].message.content;
      } else {
        throw new Error('Error calling ChatGPT API');
      }
    }

    async function fetchMetadata() {
      let url = document.getElementById('url').value;
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<div class="spinner"></div> Lade Metadaten...';

      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }

      const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);

      if (response.ok) {
        const data = await response.json();
        const parser = new DOMParser();
        const htmlDoc = parser.parseFromString(data.contents, 'text/html');
        
        const title = htmlDoc.querySelector('title').innerText;
        const descriptionMeta = htmlDoc.querySelector('meta[name="description"]');
        const description = descriptionMeta ? descriptionMeta.getAttribute('content') : 'Keine Beschreibung gefunden';

        const messages = [
          { role: 'system', content: 'summarize the following:' },
          { role: 'user', content: `Title: ${title}\nDescription: ${description}` }
        ];

        try {
          const summary = await callChatGPT(messages);
          resultDiv.innerHTML = `
            <h2>Zusammenfassung:</h2>
            <p>${summary}</p>
          `;
        } catch (error) {
          resultDiv.innerHTML = 'Fehler beim Abrufen der Zusammenfassung';
        }
      } else {
        resultDiv.innerHTML = 'Fehler beim Abrufen der Metadaten';
      }
    }
  </script>
</body>
</html>
